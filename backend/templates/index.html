<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Generator</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="header">
    <h1>Recipe Generator</h1>
</div>

<div class="main-container">
    <div class="container">
        <div class="login-container">
            <a href="/authorize" class="kakao-js-login">Login with Kakao</a>
        </div>
    </div>

    <div class="container">
        <div class="section-title">User Actions</div>
        <div class="button-group">
            <button onclick="getProfile()">Get Profile</button>
            <button onclick="sendMessage()">Send Message</button>
            <button onclick="logout()">Logout</button>
            <button onclick="unlink()">Unlink</button>
        </div>
    </div>

    <div class="container">
        <div class="section-title">Recipe Generator</div>
        <div class="api-container">
            <button onclick="generateRecipe()">Generate Recipe</button>
            <div id="recipe-result" class="notice" style="display: none;">
                <h3>Generated Recipe</h3>
                <div id="recipe-content"></div>
                <div class="button-group">
                    <button onclick="saveRecipe()">Save Recipe</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile" class="container" style="display: none;">
        <div class="section-title">Profile Information</div>
        <div class="notice">
            <pre id="profile-content"></pre>
        </div>
    </div>
</div>

<script>
    // Get token from URL and store it
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
        localStorage.setItem('kakaoToken', token);
        // Remove token from URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    let currentRecipe = null;

    async function getProfile() {
        const token = localStorage.getItem('kakaoToken');
        if (!token) {
            alert('Please login first');
            return;
        }

        try {
            const response = await fetch('/profile', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            document.getElementById('profile').style.display = 'block';
            document.getElementById('profile-content').textContent = JSON.stringify(data, null, 2);
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to get profile');
        }
    }

    async function sendMessage() {
        const token = localStorage.getItem('kakaoToken');
        if (!token) {
            alert('Please login first');
            return;
        }

        try {
            const response = await fetch('/message', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            alert('Message sent successfully');
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to send message');
        }
    }

    async function logout() {
        const token = localStorage.getItem('kakaoToken');
        if (!token) {
            alert('Please login first');
            return;
        }

        try {
            const response = await fetch('/logout', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            localStorage.removeItem('kakaoToken');
            alert('Logged out successfully');
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to logout');
        }
    }

    async function unlink() {
        const token = localStorage.getItem('kakaoToken');
        if (!token) {
            alert('Please login first');
            return;
        }

        try {
            const response = await fetch('/unlink', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            localStorage.removeItem('kakaoToken');
            alert('Unlinked successfully');
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to unlink');
        }
    }

    async function generateRecipe() {
        const token = localStorage.getItem('kakaoToken');
        if (!token) {
            alert('Please login first');
            return;
        }

        try {
            console.log('Generating recipe...');
            const response = await fetch('/generate-recipe', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error('Server error:', errorData);
                throw new Error(errorData.detail || 'Failed to generate recipe');
            }

            const data = await response.json();
            console.log('Recipe generated:', data);
            currentRecipe = data;

            // Display recipe
            const recipeContent = document.getElementById('recipe-content');
            recipeContent.innerHTML =
                    '<h4>' + data.title + '</h4>' +
                    '<p>' + data.subtitle + '</p>' +
                    '<h5>Ingredients:</h5>' +
                    '<ul>' +
                    data.ingredients.map(ing => '<li>' + ing + '</li>').join('') +
                    '</ul>' +
                    '<h5>Seasonings:</h5>' +
                    '<ul>' +
                    data.seasonings.map(ing => '<li>' + ing + '</li>').join('') +
                    '</ul>' +
                    '<h5>Steps:</h5>' +
                    '<ol>' +
                    data.steps.map(step => '<li>' + step + '</li>').join('') +
                    '</ol>' +
                    '<p><a href="' + data.youtubeLink + '" target="_blank">Watch on YouTube</a></p>';
            document.getElementById('recipe-result').style.display = 'block';
        } catch (error) {
            console.error('Error details:', error);
            alert('Failed to generate recipe: ' + error.message);
        }
    }

    async function saveRecipe() {
        const token = localStorage.getItem('kakaoToken');
        if (!token || !currentRecipe) {
            alert('Please login first and generate a recipe');
            return;
        }

        try {
            const response = await fetch('/save-recipe', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: currentRecipe.title,
                    subtitle: currentRecipe.subtitle,
                    youtubeLink: currentRecipe.youtubeLink,
                    steps: currentRecipe.steps,
                    ingredients: currentRecipe.ingredients,
                    seasonings: currentRecipe.seasonings
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to save recipe');
            }

            const data = await response.json();
            alert('Recipe saved successfully!');
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to save recipe: ' + error.message);
        }
    }
</script>
</body>

</html>